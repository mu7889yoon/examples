<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>問い合わせフォーム</title>
</head>
<body>
    <h1>問い合わせフォーム</h1>    
    <form id="contact-form" method="post">
        <div>
            <label for="name">氏名:</label><br>
            <input type="text" id="name" name="name" required>
        </div>
        
        <div>
            <label for="furigana">フリガナ:</label><br>
            <input type="text" id="furigana" name="furigana" required>
        </div>
        
        <div>
            <label for="postal">郵便番号:</label><br>
            <input type="text" id="postal" name="postal">
        </div>
        
        <div>
            <label for="address">住所:</label><br>
            <input type="text" id="address" name="address">
        </div>
        
        <div>
            <label for="email">メールアドレス:</label><br>
            <input type="email" id="email" name="email" required>
        </div>
        
        <div>
            <label>好きなペット:</label><br>
            <input type="radio" id="dog" name="pet" value="dog" required>
            <label for="dog">犬</label><br>
            <input type="radio" id="cat" name="pet" value="cat">
            <label for="cat">猫</label><br>
            <input type="radio" id="bird" name="pet" value="bird">
            <label for="bird">鳥</label><br>            
        </div>
        
        <div>
            <label for="question">質問:</label><br>
            <textarea id="question" name="question" rows="5" cols="50"></textarea>
        </div>
        
        <div>
            <input type="checkbox" id="agree" name="agree">
            <label for="agree">同意する</label>
        </div>
        
        <div>
            <input type="submit" value="送信">
        </div>
    </form>
    <script>
    (function () {
        // API GatewayのエンドポイントベースURL
        // デプロイ後のスタック出力 `ApiEndpoint` の値をここに設定してください
        // 例: 'https://xxxxx.execute-api.ap-northeast-1.amazonaws.com/prod/'
        var API_BASE = window.API_BASE || 'https://9pzonhxa6b.execute-api.ap-northeast-1.amazonaws.com/prod/';

        var form = document.getElementById('contact-form');
        if (!form) return;
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            if (!API_BASE) {
                alert('APIエンドポイントが未設定です。デプロイ後にwindow.API_BASEにURLを設定してください。');
                return;
            }

            var data = {
                name: document.getElementById('name').value,
                furigana: document.getElementById('furigana').value,
                postal: (function(){
                    var v = document.getElementById('postal').value; 
                    return v && v.trim() !== '' ? v : null;
                })(),
                address: document.getElementById('address').value,
                email: document.getElementById('email').value,
                pet: (function(){
                    var rds = document.querySelectorAll('input[name="pet"]');
                    for (var i = 0; i < rds.length; i++) { 
                        if (rds[i].checked) return rds[i].value; 
                    }
                    return null;
                })(),
                question: (function(){
                    var v = document.getElementById('question').value; 
                    return v && v.length ? v : null;
                })(),
                agree: document.getElementById('agree').checked === true
            };

            fetch(API_BASE + 'contact', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(function(res){
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return res.json();
            }).then(function(json){
                if (json && json.isValid === true) {
                    window.location.href = 'finish.html';
                } else if (json && json.errors && json.errors.length) {
                    var msg = json.errors.map(function(e){ 
                        return e.field + ': ' + e.message; 
                    }).join('\n');
                    alert('入力エラー:\n' + msg);
                } else {
                    alert('不明な応答です');
                }
            }).catch(function(err){
                alert('送信に失敗しました: ' + err.message);
            });
        });
    })();
    </script>
</body>
</html>
